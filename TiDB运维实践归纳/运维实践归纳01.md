# 运维实践归纳01


TiDB-转换字符集



```
MySQL [jan]> CREATE TABLE `t` (     
    ->   `a` varchar(10) DEFAULT NULL 
    ->  ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;
Query OK, 0 rows affected (0.12 sec)

MySQL [jan]> show variables like '%tidb_skip_utf8_check%';
+----------------------+-------+
| Variable_name        | Value |
+----------------------+-------+
| tidb_skip_utf8_check | 0     |
+----------------------+-------+
1 row in set (0.00 sec)

MySQL [jan]> insert t values (unhex('f09f8c80'));
Query OK, 1 row affected (0.03 sec)

MySQL [jan]> select * from t;
+------+
| a    |
+------+
|      |
+------+
1 row in set (0.01 sec)

MySQL [jan]> alter table t change column a a varchar(20) character set utf8mb4;
Query OK, 0 rows affected (0.19 sec)

MySQL [jan]> alter table t convert to character set utf8mb4;
Query OK, 0 rows affected (0.11 sec)

MySQL [jan]> show create table from t;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your TiDB version for the right syntax to use line 1 column 22 near "from t" 
MySQL [jan]> show create table t;
+-------+---------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                  |
+-------+---------------------------------------------------------------------------------------------------------------+
| t     | CREATE TABLE `t` (
  `a` varchar(20) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin |
+-------+---------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
```


## Collation问题
TiDB 4.0 新增了完整的 Collation 支持框架，允许实现所有 MySQL 中的 Collation，并新增了配置开关 new_collation_enabled_on_first_boostrap，在集群初次初始化时决定是否启用新 Collation 框架。在该配置开关打开之后初始化集群，可以通过 mysql.tidb 表中的 new_collation_enabled 变量确认新 Collation 是否启用：

在新 Collation 启用后，TiDB 修正了 utf8mb4_general_bin 和 utf8_general_bin 的 PADDING 行为
```
MySQL [jan]> select VARIABLE_VALUE from mysql.tidb where VARIABLE_NAME='new_collation_enabled'\G
*************************** 1. row ***************************
VARIABLE_VALUE: False
1 row in set (0.00 sec)
```

## 系统时区问题

(2) 系统时区

在 MySQL 中，系统时区 system_time_zone 在 MySQL 服务启动时通过 环境变量 TZ 或命令行参数 --timezone 指定。

对于 TiDB 而言，作为一个分布式数据库，TiDB 需要保证整个集群的系统时区始终一致。因此 TiDB 的系统时区在集群初始化时，由负责初始化的 TiDB 节点环境变量 TZ 决定。集群初始化后，固定在集群状态表 mysql.tidb 中：

tidb> select VARIABLE_VALUE from mysql.tidb where VARIABLE_NAME='system_tz';
+----------------+
| VARIABLE_VALUE |
+----------------+
| Asia/Shanghai  |
+----------------+
1 row in set (0.00 sec)
通过查看 system_time_zone 变量，可以看到该值与状态表中的 system_tz 保持一致：

tidb> select @@system_time_zone;
+--------------------+
| @@system_time_zone |
+--------------------+
| Asia/Shanghai      |
+--------------------+
1 row in set (0.00 sec)
请注意，这意味着 TiDB 的系统时区在初始化后不再更改。若需要改变集群的时区，可以显式指定 time_zone 系统变量，例如：

tidb> set @@global.time_zone='UTC';
Query OK, 0 rows affected (0.00 sec)


## 乐观锁冲突检测

```
MySQL [(none)]> show global variables like '%tidb_disable_txn_auto_retry%';
+-----------------------------+-------+
| Variable_name               | Value |
+-----------------------------+-------+
| tidb_disable_txn_auto_retry | 1     |
+-----------------------------+-------+
1 row in set (0.57 sec)

MySQL [(none)]> show global variables like '%tidb_retry_limit%';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| tidb_retry_limit | 10    |
+------------------+-------+
1 row in set (0.55 sec)

MySQL [(none)]> 
MySQL [(none)]> 
MySQL [(none)]> 
MySQL [(none)]> set @@global.tidb_disable_txn_auto_retry = 0;
Query OK, 0 rows affected (0.02 sec)

MySQL [(none)]> set @@global.tidb_retry_limit = 10;
Query OK, 0 rows affected (0.01 sec)

MySQL [(none)]> show global variables like '%tidb_disable_txn_auto_retry%';
+-----------------------------+-------+
| Variable_name               | Value |
+-----------------------------+-------+
| tidb_disable_txn_auto_retry | 0     |
+-----------------------------+-------+
1 row in set (0.56 sec)

MySQL [(none)]> show global variables like '%tidb_retry_limit%';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| tidb_retry_limit | 10    |
+------------------+-------+
1 row in set (0.53 sec)

```



## GC时间

```
MySQL [(none)]> select VARIABLE_NAME, VARIABLE_VALUE from mysql.tidb;
+--------------------------+----------------------------------------------------------------------------------------------+
| VARIABLE_NAME            | VARIABLE_VALUE                                                                               |
+--------------------------+----------------------------------------------------------------------------------------------+
| bootstrapped             | True                                                                                         |
| tidb_server_version      | 49                                                                                           |
| system_tz                | America/New_York                                                                             |
| new_collation_enabled    | False                                                                                        |
| tikv_gc_leader_uuid      | 5dbadf60d4c0004                                                                              |
| tikv_gc_leader_desc      | host:tiup-tidb42, pid:1083, start at 2021-01-10 03:50:40.038586851 -0500 EST m=+66.725259301 |
| tikv_gc_leader_lease     | 20210110-23:07:42 -0500                                                                      |
| tikv_gc_enable           | true                                                                                         |
| tikv_gc_run_interval     | 10m0s                                                                                        |
| tikv_gc_life_time        | 10m0s                                                                                        |
| tikv_gc_last_run_time    | 20210110-23:00:42 -0500                                                                      |
| tikv_gc_safe_point       | 20210110-22:50:42 -0500                                                                      |
| tikv_gc_auto_concurrency | true                                                                                         |
| tikv_gc_mode             | distributed                                                                                  |
+--------------------------+----------------------------------------------------------------------------------------------+
14 rows in set (0.01 sec)

```

## 悲观锁尝试
```
v3.0.8 及之后版本新建的 TiDB 集群将默认使用悲观事务模式，从乐观事务模式升级的集群仍将使用乐观事务模式。进入悲观事务模式有以下三种方式:

执行 BEGIN PESSIMISTIC; 语句开启的事务，会进入悲观事务模式。

可以通过写成注释的形式 BEGIN /*!90000 PESSIMISTIC */; 来兼容 MySQL 语法。

执行 set @@tidb_txn_mode = 'pessimistic';，使这个 session 执行的所有显式事务（即非 autocommit 的事务）都会进入悲观事务模式。

执行 set @@global.tidb_txn_mode = 'pessimistic';，使之后整个集群所有新创建 session 执行的所有显示事务（即非 autocommit 的事务）都会进入悲观事务模式。

可通过执行 set @@global.tidb_txn_mode = ''; 还原回乐观事务模式。
```

## Batch DML
从上面可以看到，悲观事务在执行每个 DML 时都需要向 TiKV 发送加锁请求，如果事务内 DML 数量很多但 DML 操作很小时，加锁操作会显著增加事务的延迟，所以建议使用悲观事务时尽可能用一条 DML 操作更多的数据。

例如：以下每条 INSERT 都需要向 TiKV 中写入悲观锁，带来了极大的延迟：
```
BEGIN;
INSERT INTO my_table VALUES (1);
INSERT INTO my_table VALUES (2);
INSERT INTO my_table VALUES (3);
COMMIT;
如果修改为 INSERT 多行，性能将会成倍的提升：

BEGIN;
INSERT INTO my_table VALUES (1), (2), (3);
```

## 大事务的实现

在 4.0 之前版本，如果执行几十万条数据的插入或复制操作，需要用特殊方法来才绕过事务限制，比如开启 tidb_batch_insert 等，但是这些操作是受限且不安全的，未来版本中会被逐渐废弃掉。而在新版本中，可以直接通过大事务支持的特性，来解决老版本中事务限制的问题。
```

```

## 定位大表并发写入瓶颈
```
[tidb@tiup-tidb41 conf]$ tiup ctl pd region topwrite
Found ctl newer version:

    The latest version:         v4.0.9
    Local installed version:    v4.0.2
    Update current component:   tiup update ctl
    Update all components:      tiup update --all

Starting component `ctl`: /home/tidb/.tiup/components/ctl/v4.0.2/ctl pd region topwrite
{
  "count": 16,
  "regions": [
    {
      "id": 34,
      "start_key": "7480000000000000FF1500000000000000F8",
      "end_key": "7480000000000000FF1700000000000000F8",
      "epoch": {
        "conf_ver": 17,
        "version": 11
      },
      "peers": [
        {
          "id": 36,
          "store_id": 4
        },
        {
          "id": 112,
          "store_id": 6
        },
        {
          "id": 1024,
          "store_id": 1
        }
      ],
      "leader": {
        "id": 112,
        "store_id": 6
      },
      "written_bytes": 890,
      "read_bytes": 290994,
      "written_keys": 14,
      "read_keys": 5351,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 28,
      "start_key": "7480000000000000FF1100000000000000F8",
      "end_key": "7480000000000000FF1300000000000000F8",
      "epoch": {
        "conf_ver": 11,
        "version": 9
      },
      "peers": [
        {
          "id": 30,
          "store_id": 4
        },
        {
          "id": 74,
          "store_id": 6
        },
        {
          "id": 1022,
          "store_id": 1
        }
      ],
      "leader": {
        "id": 74,
        "store_id": 6
      },
      "written_bytes": 464,
      "read_bytes": 1983,
      "written_keys": 5,
      "read_keys": 18,
      "approximate_size": 1,
      "approximate_keys": 1917
    },
    {
      "id": 46,
      "start_key": "7480000000000000FF1D00000000000000F8",
      "end_key": "7480000000000000FF1F00000000000000F8",
      "epoch": {
        "conf_ver": 11,
        "version": 15
      },
      "peers": [
        {
          "id": 47,
          "store_id": 1
        },
        {
          "id": 80,
          "store_id": 6
        },
        {
          "id": 1028,
          "store_id": 4
        }
      ],
      "leader": {
        "id": 47,
        "store_id": 1
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 2
    },
    {
      "id": 58,
      "start_key": "7480000000000000FF2500000000000000F8",
      "end_key": "7480000000000000FF2700000000000000F8",
      "epoch": {
        "conf_ver": 5,
        "version": 19
      },
      "peers": [
        {
          "id": 59,
          "store_id": 1
        },
        {
          "id": 60,
          "store_id": 4
        },
        {
          "id": 84,
          "store_id": 6
        }
      ],
      "leader": {
        "id": 84,
        "store_id": 6
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 16,
      "start_key": "7480000000000000FF0900000000000000F8",
      "end_key": "7480000000000000FF0B00000000000000F8",
      "epoch": {
        "conf_ver": 17,
        "version": 5
      },
      "peers": [
        {
          "id": 17,
          "store_id": 1
        },
        {
          "id": 70,
          "store_id": 6
        },
        {
          "id": 1019,
          "store_id": 4
        }
      ],
      "leader": {
        "id": 70,
        "store_id": 6
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 31,
      "start_key": "7480000000000000FF1300000000000000F8",
      "end_key": "7480000000000000FF1500000000000000F8",
      "epoch": {
        "conf_ver": 17,
        "version": 10
      },
      "peers": [
        {
          "id": 33,
          "store_id": 4
        },
        {
          "id": 75,
          "store_id": 6
        },
        {
          "id": 1023,
          "store_id": 1
        }
      ],
      "leader": {
        "id": 1023,
        "store_id": 1
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 13,
      "start_key": "7480000000000000FF0700000000000000F8",
      "end_key": "7480000000000000FF0900000000000000F8",
      "epoch": {
        "conf_ver": 17,
        "version": 4
      },
      "peers": [
        {
          "id": 15,
          "store_id": 4
        },
        {
          "id": 107,
          "store_id": 1
        },
        {
          "id": 1018,
          "store_id": 6
        }
      ],
      "leader": {
        "id": 1018,
        "store_id": 6
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 10,
      "start_key": "7480000000000000FF0500000000000000F8",
      "end_key": "7480000000000000FF0700000000000000F8",
      "epoch": {
        "conf_ver": 17,
        "version": 3
      },
      "peers": [
        {
          "id": 68,
          "store_id": 6
        },
        {
          "id": 106,
          "store_id": 1
        },
        {
          "id": 1017,
          "store_id": 4
        }
      ],
      "leader": {
        "id": 106,
        "store_id": 1
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 19,
      "start_key": "7480000000000000FF0B00000000000000F8",
      "end_key": "7480000000000000FF0D00000000000000F8",
      "epoch": {
        "conf_ver": 17,
        "version": 6
      },
      "peers": [
        {
          "id": 71,
          "store_id": 6
        },
        {
          "id": 109,
          "store_id": 4
        },
        {
          "id": 1020,
          "store_id": 1
        }
      ],
      "leader": {
        "id": 1020,
        "store_id": 1
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 22,
      "start_key": "7480000000000000FF0D00000000000000F8",
      "end_key": "7480000000000000FF0F00000000000000F8",
      "epoch": {
        "conf_ver": 5,
        "version": 7
      },
      "peers": [
        {
          "id": 23,
          "store_id": 1
        },
        {
          "id": 24,
          "store_id": 4
        },
        {
          "id": 72,
          "store_id": 6
        }
      ],
      "leader": {
        "id": 24,
        "store_id": 4
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 55,
      "start_key": "7480000000000000FF2300000000000000F8",
      "end_key": "7480000000000000FF2500000000000000F8",
      "epoch": {
        "conf_ver": 17,
        "version": 18
      },
      "peers": [
        {
          "id": 56,
          "store_id": 1
        },
        {
          "id": 57,
          "store_id": 4
        },
        {
          "id": 1031,
          "store_id": 6
        }
      ],
      "leader": {
        "id": 57,
        "store_id": 4
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 61,
      "start_key": "7480000000000000FF2700000000000000F8",
      "end_key": "7480000000000000FF2900000000000000F8",
      "epoch": {
        "conf_ver": 11,
        "version": 20
      },
      "peers": [
        {
          "id": 62,
          "store_id": 1
        },
        {
          "id": 63,
          "store_id": 4
        },
        {
          "id": 117,
          "store_id": 6
        }
      ],
      "leader": {
        "id": 62,
        "store_id": 1
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 2,
      "start_key": "7480000000000000FF3700000000000000F8",
      "end_key": "",
      "epoch": {
        "conf_ver": 11,
        "version": 24
      },
      "peers": [
        {
          "id": 3,
          "store_id": 1
        },
        {
          "id": 5,
          "store_id": 4
        },
        {
          "id": 119,
          "store_id": 6
        }
      ],
      "leader": {
        "id": 3,
        "store_id": 1
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 7,
      "start_key": "",
      "end_key": "7480000000000000FF0500000000000000F8",
      "epoch": {
        "conf_ver": 11,
        "version": 2
      },
      "peers": [
        {
          "id": 8,
          "store_id": 1
        },
        {
          "id": 67,
          "store_id": 6
        },
        {
          "id": 105,
          "store_id": 4
        }
      ],
      "leader": {
        "id": 8,
        "store_id": 1
      },
      "written_bytes": 0,
      "read_bytes": 6255,
      "written_keys": 0,
      "read_keys": 105,
      "approximate_size": 1,
      "approximate_keys": 157
    },
    {
      "id": 49,
      "start_key": "7480000000000000FF1F00000000000000F8",
      "end_key": "7480000000000000FF2100000000000000F8",
      "epoch": {
        "conf_ver": 11,
        "version": 16
      },
      "peers": [
        {
          "id": 50,
          "store_id": 1
        },
        {
          "id": 81,
          "store_id": 6
        },
        {
          "id": 1029,
          "store_id": 4
        }
      ],
      "leader": {
        "id": 50,
        "store_id": 1
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    },
    {
      "id": 40,
      "start_key": "7480000000000000FF1900000000000000F8",
      "end_key": "7480000000000000FF1B00000000000000F8",
      "epoch": {
        "conf_ver": 17,
        "version": 13
      },
      "peers": [
        {
          "id": 41,
          "store_id": 1
        },
        {
          "id": 114,
          "store_id": 4
        },
        {
          "id": 1026,
          "store_id": 6
        }
      ],
      "leader": {
        "id": 114,
        "store_id": 4
      },
      "written_bytes": 0,
      "read_bytes": 0,
      "written_keys": 0,
      "read_keys": 0,
      "approximate_size": 1,
      "approximate_keys": 0
    }
  ]
}



[tidb@tiup-tidb41 conf]$ curl http://192.168.169.41:10080/regions/34
{
 "start_key": "dIAAAAAAAAAV",
 "end_key": "dIAAAAAAAAAX",
 "start_key_hex": "748000000000000015",
 "end_key_hex": "748000000000000017",
 "region_id": 34,
 "frames": [
  {
   "db_name": "mysql",
   "table_name": "stats_meta",
   "table_id": 21,
   "is_record": false,
   "index_name": "idx_ver",
   "index_id": 1
  },
  {
   "db_name": "mysql",
   "table_name": "stats_meta",
   "table_id": 21,
   "is_record": false,
   "index_name": "tbl",
   "index_id": 2
  },
  {
   "db_name": "mysql",
   "table_name": "stats_meta",
   "table_id": 21,
   "is_record": true
  }
 ]
}[tidb@tiup-tidb41 conf]$ 

```
解决办法

```
TiDB 对于 PK 非整数或没有 PK 的表，会使用一个隐式的自增主键 rowID：_tidb_rowid，这个隐藏的自增主键可以通过设置 SHARD_ROW_ID_BITS 来把 rowID 打散写入多个不同的 Region 中，缓解写入热点问题。但是设置的过大也会造成 RPC 请求数放大，增加 CPU 和网络开销。

SHARD_ROW_ID_BITS = 4 表示 2^4（16） 个分片
SHARD_ROW_ID_BITS = 6 表示 2^6（64） 个分片
SHARD_ROW_ID_BITS = 0 则表示默认值 1 个分片
使用示例：

CREATE TABLE t (c int) SHARD_ROW_ID_BITS = 4;
ALTER TABLE t SHARD_ROW_ID_BITS = 4;
SHARD_ROW_ID_BITS 的值可以动态修改，每次修改之后，只对新写入的数据生效。可以根据业务并发度来设置合适的值来尽量解决此类热点 Region 无法打散的问题。

另外在 TiDB 3.1.0 版本中还引入了一个新的关键字 AUTO_RANDOM （实验功能），这个关键字可以声明在表的整数类型主键上，替代 AUTO_INCREMENT，让 TiDB 在插入数据时自动为整型主键列分配一个值，消除行 ID 的连续性，从而达到打散热点的目的，更详细的信息可以参考 AUTO_RANDOM 详细说明。

2.新表高并发读写的瓶颈问题


MySQL [jan]> ALTER TABLE jan SHARD_ROW_ID_BITS = 4;
ERROR 1146 (42S02): Table 'jan.jan' doesn't exist
MySQL [jan]> ALTER TABLE jan_test SHARD_ROW_ID_BITS = 4;
Query OK, 0 rows affected (3.35 sec)

MySQL [jan]> show create table jan_test\G
*************************** 1. row ***************************
       Table: jan_test
Create Table: CREATE TABLE `jan_test` (
  `id` int(11) DEFAULT NULL,
  `name` varchar(20) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin/*!90000 SHARD_ROW_ID_BITS=4 */
1 row in set (0.00 sec)
```


## 热点打散

```
SPLIT TABLE jan_test BETWEEN (0) AND (1600000) REGIONS 100;

SHOW TABLE test_hotspot REGIONS; 语句查看打散的情况。如果 SCATTERING 列值全部为 0，代表调度成功。
```

也可以通过 table-regions.py 脚本，查看 


## autorandom使用
```
MySQL [jan]> create table t (a int primary key auto_random);
ERROR 8216 (HY000): Invalid auto random: auto_random option must be defined on `bigint` column, but not on `int` column
MySQL [jan]> drop table t;
Query OK, 0 rows affected (0.23 sec)

MySQL [jan]> create table t (a int primary key auto_random);
ERROR 8216 (HY000): Invalid auto random: auto_random option must be defined on `bigint` column, but not on `int` column
MySQL [jan]> create table t (a bigint primary key auto_random);
Query OK, 0 rows affected, 1 warning (0.54 sec)

MySQL [jan]> insert into t values (), ();
Query OK, 2 rows affected (0.03 sec)
Records: 2  Duplicates: 0  Warnings: 0

MySQL [jan]> select * from t;
+---------------------+
| a                   |
+---------------------+
| 5476377146882523137 |
| 5476377146882523138 |
+---------------------+
2 rows in set (0.00 sec)

MySQL [jan]> insert into t values (), ();
Query OK, 2 rows affected (0.02 sec)
Records: 2  Duplicates: 0  Warnings: 0

MySQL [jan]> select * from t;
+---------------------+
| a                   |
+---------------------+
| 1152921504606846979 |
| 1152921504606846980 |
| 5476377146882523137 |
| 5476377146882523138 |
+---------------------+
4 rows in set (0.00 sec)

MySQL [jan]> select last_insert_id();
+---------------------+
| last_insert_id()    |
+---------------------+
| 1152921504606846979 |
+---------------------+
1 row in set (0.00 sec)


```
如果该 INSERT 语句没有指定整型主键列（a 列）的值，TiDB 会为该列自动分配值。该值不保证自增，不保证连续，只保证唯一，避免了连续的行 ID 带来的热点问题。
如果该 INSERT 语句显式指定了整型主键列的值，和 AutoIncrement 属性类似，TiDB 会保存该值。
若在单条 INSERT 语句中写入多个值，AutoRandom 属性会保证分配 ID 的连续性，同时 LAST_INSERT_ID() 返回第一个分配的值，这使得可以通过 LAST_INSERT_ID() 结果推断出所有被分配的 ID。



## TiFlash的使用

```
MySQL [jan]> ALTER TABLE jan.jan_test SET TIFLASH REPLICA 1; 
Query OK, 0 rows affected (0.26 sec)

MySQL [jan]> SELECT * FROM information_schema.tiflash_replica
    -> WHERE TABLE_SCHEMA = 'jan' and TABLE_NAME = 'jan_test';
+--------------+------------+----------+---------------+-----------------+-----------+----------+
| TABLE_SCHEMA | TABLE_NAME | TABLE_ID | REPLICA_COUNT | LOCATION_LABELS | AVAILABLE | PROGRESS |
+--------------+------------+----------+---------------+-----------------+-----------+----------+
| jan          | jan_test   |       48 |             1 |                 |         1 |        1 |
+--------------+------------+----------+---------------+-----------------+-----------+----------+
1 row in set (0.01 sec)

MySQL [jan]> create table jan_test_tiflash like jan.jan_test;
Query OK, 0 rows affected (0.26 sec)

MySQL [jan]> SELECT * FROM information_schema.tiflash_replica
    -> WHERE TABLE_SCHEMA = 'jan' and TABLE_NAME = 'jan_test_tiflash';
+--------------+------------------+----------+---------------+-----------------+-----------+----------+
| TABLE_SCHEMA | TABLE_NAME       | TABLE_ID | REPLICA_COUNT | LOCATION_LABELS | AVAILABLE | PROGRESS |
+--------------+------------------+----------+---------------+-----------------+-----------+----------+
| jan          | jan_test_tiflash |       78 |             1 |                 |         1 |        1 |
+--------------+------------------+----------+---------------+-----------------+-----------+----------+
1 row in set (0.01 sec)

MySQL [jan]> explain select count(*) from jan.jan_test where name='jan_test1';
+------------------------------+---------+--------------+----------------+------------------------------------+
| id                           | estRows | task         | access object  | operator info                      |
+------------------------------+---------+--------------+----------------+------------------------------------+
| StreamAgg_34                 | 1.00    | root         |                | funcs:count(Column#9)->Column#4    |
| └─TableReader_35             | 1.00    | root         |                | data:StreamAgg_9                   |
|   └─StreamAgg_9              | 1.00    | cop[tiflash] |                | funcs:count(1)->Column#9           |
|     └─Selection_31           | 5.12    | cop[tiflash] |                | eq(jan.jan_test.name, "jan_test1") |
|       └─TableFullScan_30     | 5120.00 | cop[tiflash] | table:jan_test | keep order:false                   |
+------------------------------+---------+--------------+----------------+------------------------------------+
5 rows in set (0.03 sec)

```


## 权限管理

```
MySQL [jan]> create role reader@'%';
Query OK, 0 rows affected (0.11 sec)

MySQL [jan]> grant select on mysql.role_edges to reader'%';
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your TiDB version for the right syntax to use line 1 column 45 near "'%'" 
MySQL [jan]> grant select on mysql.role_edges to reader@'%';
Query OK, 0 rows affected (0.33 sec)

MySQL [jan]> create user bi_user@'%';
Query OK, 0 rows affected (0.06 sec)

MySQL [jan]> grant reader to bi_user@'%';
Query OK, 0 rows affected (0.06 sec)

MySQL [jan]> exit
Bye
[tidb@tiup-tidb41 conf]$ mysql -ureader -P4000 -h192.168.169.41
ERROR 1045 (28000): Access denied for user 'reader'@'192.168.169.41' (using password: NO)
[tidb@tiup-tidb41 conf]$ mysql -ureader -P4000 -h192.168.169.41
ERROR 1045 (28000): Access denied for user 'reader'@'192.168.169.41' (using password: NO)
[tidb@tiup-tidb41 conf]$ mysql -ureader -P4000 -h192.168.169.41 -p
Enter password: 
ERROR 1045 (28000): Access denied for user 'reader'@'192.168.169.41' (using password: YES)
[tidb@tiup-tidb41 conf]$ mysql -ureader -P4000 -h192.168.169.41 -p
Enter password: 
ERROR 1045 (28000): Access denied for user 'reader'@'192.168.169.41' (using password: NO)
[tidb@tiup-tidb41 conf]$ mysql -uroot -P4000 -h192.168.169.41
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 23
Server version: 5.7.25-TiDB-v4.0.9 TiDB Server (Apache License 2.0) Community Edition, MySQL 5.7 compatible

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> et password for reader@'%' = password('123123');
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your TiDB version for the right syntax to use line 1 column 2 near "et password for reader@'%' = password('123123')" 
MySQL [(none)]> set password for reader@'%' = password('123123');
Query OK, 0 rows affected (0.13 sec)

MySQL [(none)]> exit
Bye
[tidb@tiup-tidb41 conf]$ mysql -ureader -P4000 -h192.168.169.41 -p123123
ERROR 1045 (28000): Access denied for user 'reader'@'192.168.169.41' (using password: YES)
[tidb@tiup-tidb41 conf]$ mysql -ureader -P4000 -h192.168.169.41 -p
Enter password: 
ERROR 1045 (28000): Access denied for user 'reader'@'192.168.169.41' (using password: YES)
[tidb@tiup-tidb41 conf]$ mysql -ureader -P4000 -h192.168.169.41
ERROR 1045 (28000): Access denied for user 'reader'@'192.168.169.41' (using password: NO)
[tidb@tiup-tidb41 conf]$ 
[tidb@tiup-tidb41 conf]$ 
[tidb@tiup-tidb41 conf]$ 
[tidb@tiup-tidb41 conf]$ 
[tidb@tiup-tidb41 conf]$ mysql -uroot -P4000 -h192.168.169.41
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 27
Server version: 5.7.25-TiDB-v4.0.9 TiDB Server (Apache License 2.0) Community Edition, MySQL 5.7 compatible

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> set password for bi_user@'%' = password('123123');
Query OK, 0 rows affected (0.05 sec)

MySQL [(none)]> exit
Bye
[tidb@tiup-tidb41 conf]$ mysql -ubi_user -P4000 -h192.168.169.41
ERROR 1045 (28000): Access denied for user 'bi_user'@'192.168.169.41' (using password: NO)
[tidb@tiup-tidb41 conf]$ mysql -ubi_user -P4000 -h192.168.169.41 -p123123
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 29
Server version: 5.7.25-TiDB-v4.0.9 TiDB Server (Apache License 2.0) Community Edition, MySQL 5.7 compatible

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| INFORMATION_SCHEMA |
+--------------------+
1 row in set (0.00 sec)

MySQL [(none)]> SELECT CURRENT_ROLE();
+----------------+
| CURRENT_ROLE() |
+----------------+
|                |
+----------------+
1 row in set (0.00 sec)

MySQL [(none)]> set role reader;
Query OK, 0 rows affected (0.00 sec)

MySQL [(none)]> SELECT CURRENT_ROLE();
+----------------+
| CURRENT_ROLE() |
+----------------+
| `reader`@`%`   |
+----------------+
1 row in set (0.00 sec)

MySQL [(none)]> select * from role_edges;
ERROR 1046 (3D000): No database selected
MySQL [(none)]> select * from mysql.role_edges;
+-----------+-----------+---------+---------+-------------------+
| FROM_HOST | FROM_USER | TO_HOST | TO_USER | WITH_ADMIN_OPTION |
+-----------+-----------+---------+---------+-------------------+
| %         | reader    | %       | bi_user | N                 |
+-----------+-----------+---------+---------+-------------------+
1 row in set (0.01 sec)

MySQL [(none)]> delete from role_edges;
ERROR 1046 (3D000): No database selected
MySQL [(none)]> delete from mysql.role_edges;
ERROR 8121 (HY000): privilege check fail
MySQL [(none)]> select * from user;
ERROR 1046 (3D000): No database selected
MySQL [(none)]> select * from mysql.user;
ERROR 1142 (42000): SELECT command denied to user 'bi_user'@'%' for table 'user'
MySQL [(none)]> use mysql
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [mysql]> exit
Bye
[tidb@tiup-tidb41 conf]$ mysql -ubi_user -P4000 -h192.168.169.41 -p123123
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 30
Server version: 5.7.25-TiDB-v4.0.9 TiDB Server (Apache License 2.0) Community Edition, MySQL 5.7 compatible

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use mysql
ERROR 1044 (42000): Access denied for user 'bi_user'@'%' to database 'mysql'
MySQL [(none)]> 

MySQL [(none)]> SHOW GRANTS FOR 'bi_user'@'%' USING 'reader';
+---------------------------------------------------+
| Grants for bi_user@%                              |
+---------------------------------------------------+
| GRANT USAGE ON *.* TO 'bi_user'@'%'               |
| GRANT Select ON mysql.role_edges TO 'bi_user'@'%' |
| GRANT 'reader'@'%' TO 'bi_user'@'%'               |
+---------------------------------------------------+
3 rows in set (0.03 sec)


MySQL [(none)]> REVOKE 'reader' FROM 'bi_user'@'%';
Query OK, 0 rows affected (0.06 sec)

MySQL [(none)]> SHOW GRANTS FOR 'bi_user'@'%' USING 'reader';
ERROR 3530 (HY000): `reader`@`%` is is not granted to bi_user@%
MySQL [(none)]> select * from mysql.role_edges;
Empty set (0.01 sec)

```



## 操作TiSpark

```
[tidb@tiup-tidb41 tispark]$ pip install pyspark
DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.
Defaulting to user installation because normal site-packages is not writeable
Collecting pyspark
  Downloading pyspark-3.0.1.tar.gz (204.2 MB)
     |████████████████████████████████| 204.2 MB 2.2 kB/s 
Collecting py4j==0.10.9
  Downloading py4j-0.10.9-py2.py3-none-any.whl (198 kB)
     |████████████████████████████████| 198 kB 492 kB/s 
Building wheels for collected packages: pyspark
  Building wheel for pyspark (setup.py) ... done
  Created wheel for pyspark: filename=pyspark-3.0.1-py2.py3-none-any.whl size=204612242 sha256=fb9ddae5e417ad6311762438aad328c823a54d6c0e1ccc5732d3b0801c7a87eb
  Stored in directory: /home/tidb/.cache/pip/wheels/c1/71/6b/7d14838c7d273b3d15c333cdc776d76d982534b553129a8f30
Successfully built pyspark
Installing collected packages: py4j, pyspark
Successfully installed py4j-0.10.9 pyspark-3.0.1

```









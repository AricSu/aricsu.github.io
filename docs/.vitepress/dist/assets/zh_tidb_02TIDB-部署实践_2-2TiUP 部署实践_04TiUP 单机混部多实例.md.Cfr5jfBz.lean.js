import{_ as a,c as i,a5 as n,o as p}from"./chunks/framework.PytyN_aB.js";const E=JSON.parse('{"title":"TiDB-单机多TiKV实例、多TiDB实例部署","description":"","frontmatter":{},"headers":[],"relativePath":"zh/tidb/02TIDB-部署实践/2-2TiUP 部署实践/04TiUP 单机混部多实例.md","filePath":"zh/tidb/02TIDB-部署实践/2-2TiUP 部署实践/04TiUP 单机混部多实例.md"}'),l={name:"zh/tidb/02TIDB-部署实践/2-2TiUP 部署实践/04TiUP 单机混部多实例.md"};function t(h,s,e,k,r,d){return p(),i("div",null,s[0]||(s[0]=[n(`<h1 id="tidb-单机多tikv实例、多tidb实例部署" tabindex="-1">TiDB-单机多TiKV实例、多TiDB实例部署 <a class="header-anchor" href="#tidb-单机多tikv实例、多tidb实例部署" aria-label="Permalink to &quot;TiDB-单机多TiKV实例、多TiDB实例部署&quot;">​</a></h1><p>时间：2021-01-06</p><h2 id="summary" tabindex="-1">summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;summary&quot;">​</a></h2><blockquote><ul><li><a href="#配置inventory的TiKV部分">配置inventory的TiKV部分</a></li><li><a href="#集群节点环境配置与参数限制">集群节点环境配置与参数限制</a><ul><li><a href="#中控机操作部署机建用户">中控机操作部署机建用户</a></li><li><a href="#中控机操作部署机配置ntp服务">中控机操作部署机配置ntp服务</a></li><li><a href="#中控及操作部署机设置CPU模式">中控及操作部署机设置CPU模式</a></li></ul></li><li><a href="#ansible部署命令黄金五步骤走">ansible部署命令黄金五步骤走</a><ul><li><a href="#执行local_prepare联网下载binary包">执行local_prepare联网下载binary包</a></li><li><a href="#初始化系统环境并修改内核参数">初始化系统环境并修改内核参数</a></li><li><a href="#部署TiDB集群软件">部署TiDB集群软件</a></li><li><a href="#安装Dashboard依赖包">安装Dashboard依赖包</a></li><li><a href="#执行start启动TiDB集群">执行start启动TiDB集群</a></li></ul></li><li><a href="#验证是否安装成功">验证是否安装成功</a></li></ul></blockquote><h2 id="配置inventory的tikv部分" tabindex="-1">配置inventory的TiKV部分 <a class="header-anchor" href="#配置inventory的tikv部分" aria-label="Permalink to &quot;配置inventory的TiKV部分&quot;">​</a></h2><p>配置范例：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tidb01</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">41</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tidb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ansible]</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vi inventory.ini</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb_servers]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiDB1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.42 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10080</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiDB1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.42 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4001</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10081</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiDB2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">21</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.43 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10080</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiDB2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">22</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.43 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4001</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10081</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[pd_servers]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.41</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.42</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.43</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 注意：要使用 TiKV 的 labels，必须同时配置 PD 的 location_labels 参数，否则 labels 设置不生效。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 多实例场景需要额外配置 status 端口，示例如下：</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tikv_servers]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiKV1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.41 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20171</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20181</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> labels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;host=tikv1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiKV1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.41 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20172</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20182</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> labels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;host=tikv1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiKV2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">21</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.42 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20171</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20181</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> labels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;host=tikv2&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiKV2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">22</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.42 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20172</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20182</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> labels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;host=tikv2&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiKV3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">31</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.43 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20171</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20181</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> labels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;host=tikv3&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TiKV3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible_host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.43 deploy_dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deploy tikv_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20172</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tikv_status_port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20182</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> labels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;host=tikv3&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[monitoring_servers]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.42</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[grafana_servers]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.42</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[monitored_servers]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 192.168.1.41</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.42</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.43</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 为使 TiKV 的 labels 设置生效，部署集群时必须设置 PD 的 location_labels 参数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[pd_servers:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">vars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">location_labels </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;host&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>labels参数作用：</p><ul><li>labels 是 Region 调度的最小单元，每一个 raft group 中不同的 replica 不会在扩展过程中被迁移到同一个lable单元，避免这种情况下 server 宕机导致的单点问题（3副本，2副本落在同一个server）。</li><li>raft group 的 multi-replica 主要解决的是数据的容灾问题，labels 参数可以有效防止随数据扩展，在Region 迁移过程中因散列计算 Region 迁移位置时，由于冲撞导致的同一个 server 存储同一个 Region group 的多个 replica 的情况。</li><li>可以给一个服务器打一个 labels、可以给一个服务器机柜打一个 labels，也可以是一个 IDC 打一个 labels。</li></ul><h2 id="集群节点环境配置与参数限制" tabindex="-1">集群节点环境配置与参数限制 <a class="header-anchor" href="#集群节点环境配置与参数限制" aria-label="Permalink to &quot;集群节点环境配置与参数限制&quot;">​</a></h2><h4 id="block-cache-size下的capacity参数调整" tabindex="-1">block-cache-size下的capacity参数调整 <a class="header-anchor" href="#block-cache-size下的capacity参数调整" aria-label="Permalink to &quot;block-cache-size下的capacity参数调整&quot;">​</a></h4><p>多实例情况下，需要修改 tidb-ansible/conf/tikv.yml 中 block-cache-size 下面的 capacity 参数; 用以限制每个TiKV实例用于block-cache的内存使用限制。</p><p>官方推荐设置：capacity = MEM_TOTAL * 0.5 / TiKV 实例数量</p><p>本例：各节点内存3G，每个节点部署两台实例，因此 capacity = 3 * 0.5 / 2 = 0.75GB</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb@tidb01-41 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]$ vi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/tidb-ansible/conf/tikv.yml</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">storage:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  block-cache:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    capacity:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0.75GB&quot;</span></span></code></pre></div><h4 id="readpool下coprocessor的并发度调整" tabindex="-1">readpool下coprocessor的并发度调整 <a class="header-anchor" href="#readpool下coprocessor的并发度调整" aria-label="Permalink to &quot;readpool下coprocessor的并发度调整&quot;">​</a></h4><p>官方推荐设置： 参数值 = ( CPU 核心数量 * 0.8 ) / TiKV 实例数量</p><p>本例：各节点部署两个实例，CPU 核心数量 8 个，参数值 = ( 8 * 0.8 ) / 2 = 3</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用 shell 命令查看逻辑核心数量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb@tidb01-41 tidb-ansible]$ cat /proc/cpuinfo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;processor&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> wc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">8</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb@tidb01-41 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]$ vi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/tidb-ansible/conf/tikv.yml</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">readpool:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  coprocessor:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Notice: if CPU_NUM &gt; 8, default thread pool size for coprocessors</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # will be set to CPU_NUM * 0.8.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    high-concurrency:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    normal-concurrency:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    low-concurrency:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span></span></code></pre></div><h4 id="raftstore下的capacity参数调整" tabindex="-1">raftstore下的capacity参数调整 <a class="header-anchor" href="#raftstore下的capacity参数调整" aria-label="Permalink to &quot;raftstore下的capacity参数调整&quot;">​</a></h4><p>如果多个 TiKV 实例部署在同一块物理磁盘上，需要修改 conf/tikv.yml 中的 capacity 参数，限制每个 TiKV 实例所能使用的磁盘容量，官方推荐配置：capacity = 磁盘总容量 / TiKV 实例数量。</p><p>本例：各节点限制使用磁盘容量为 5 GB ，capacity = 5GB</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>vi ~/tidb-ansible/conf/tikv.yml</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>raftstore:</span></span>
<span class="line"><span>  capacity = 5GB</span></span></code></pre></div><h2 id="中控机操作部署机建用户" tabindex="-1">中控机操作部署机建用户 <a class="header-anchor" href="#中控机操作部署机建用户" aria-label="Permalink to &quot;中控机操作部署机建用户&quot;">​</a></h2><p>执行以下命令，依据输入<em><strong>部署目标机器</strong></em>的 root 用户密码； 本例新增节点IP为192.168.1.44；</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tidb01</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">41</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tidb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ansible]</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vi hosts.ini </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tidb01</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">41</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tidb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ansible]</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cat hosts.ini </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[servers]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1.44</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">vars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tidb</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ntp_server </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.pool.ntp.org</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tidb01</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">41</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tidb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ansible]</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansible</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">playbook </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i hosts.ini create_users.yml </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">u root </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SSH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> password: </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PLAY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***************************************************************************************************************</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">......</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">......</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Congrats! All goes well. :</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>验证互信时候成功</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ ansible -i inventory.ini all -m shell -a &#39;whoami&#39;</span></span>
<span class="line"><span>192.168.1.43 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>192.168.1.42 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiDB1-21 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiDB1-22 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiDB1-12 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>192.168.1.41 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiDB1-11 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV3-31 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV3-32 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV2-21 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV2-22 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV1-11 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV1-12 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>tidb</span></span></code></pre></div><p>验证sudo 免密码配置成功</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ ansible -i inventory.ini all -m shell -a &#39;whoami&#39; -b</span></span>
<span class="line"><span>192.168.1.43 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiDB1-12 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>192.168.1.41 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>192.168.1.42 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiDB1-11 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiDB1-21 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiDB1-22 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV2-21 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV2-22 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV3-31 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV3-32 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV1-11 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span>
<span class="line"><span></span></span>
<span class="line"><span>TiKV1-12 | SUCCESS | rc=0 &gt;&gt;</span></span>
<span class="line"><span>root</span></span></code></pre></div><h2 id="中控机操作部署机配置ntp服务" tabindex="-1">中控机操作部署机配置ntp服务 <a class="header-anchor" href="#中控机操作部署机配置ntp服务" aria-label="Permalink to &quot;中控机操作部署机配置ntp服务&quot;">​</a></h2><p><em><strong>注意：生产上应该指向自己的ntp服务器，本次测试采用了公网公用的ntp服务不稳定。</strong></em></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ ansible-playbook -i hosts.ini deploy_ntp.yml -u tidb -b</span></span>
<span class="line"><span></span></span>
<span class="line"><span>......</span></span>
<span class="line"><span>......</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Congrats! All goes well. :-)</span></span></code></pre></div><h2 id="中控及操作部署机设置cpu模式" tabindex="-1">中控及操作部署机设置CPU模式 <a class="header-anchor" href="#中控及操作部署机设置cpu模式" aria-label="Permalink to &quot;中控及操作部署机设置CPU模式&quot;">​</a></h2><p>调整CPU模式，如果同本文出现一样的报错，说明此版本的操作系统不支持CPU模式修改，可直接跳过。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb@tidb01-41 tidb-ansible]$ ansible -i hosts.ini all -m shell -a </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cpupower frequency-set --governor performance&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -u tidb -b</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">192.168.1.44</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FAILED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">237</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &gt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Setting</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cpu:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Error</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setting</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> new</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> values.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Common</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> errors:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Do</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> have</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proper</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> administration</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rights?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (super-user?)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> governor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> requested</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> available</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> and</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> modprobed?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Trying</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> an</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> invalid</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> policy?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Trying</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> specific</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> frequency,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> but</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> userspace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> governor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> not</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> available,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> example because of hardware which cannot be set to a specific frequency</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   or</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> because</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> userspace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> governor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> isn&#39;t loaded?non-zero return code</span></span></code></pre></div><h2 id="ansible部署命令黄金五步骤走" tabindex="-1">ansible部署命令黄金五步骤走 <a class="header-anchor" href="#ansible部署命令黄金五步骤走" aria-label="Permalink to &quot;ansible部署命令黄金五步骤走&quot;">​</a></h2><h4 id="执行local-prepare联网下载binary包" tabindex="-1">执行local_prepare联网下载binary包 <a class="header-anchor" href="#执行local-prepare联网下载binary包" aria-label="Permalink to &quot;执行local_prepare联网下载binary包&quot;">​</a></h4><p>执行 local_prepare.yml playbook，联网下载 TiDB binary 至中控机。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[tidb@tidb01-41 tidb-ansible]$ ansible-playbook local_prepare.yml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PLAY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [do </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preparation]</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ***************************************************************************</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">......</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">......</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Congrats!</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> All</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> goes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> well.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h4 id="初始化系统环境并修改内核参数" tabindex="-1">初始化系统环境并修改内核参数 <a class="header-anchor" href="#初始化系统环境并修改内核参数" aria-label="Permalink to &quot;初始化系统环境并修改内核参数&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ ansible-playbook bootstrap.yml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PLAY [initializing deployment target] *****************************************************************</span></span>
<span class="line"><span></span></span>
<span class="line"><span>......</span></span>
<span class="line"><span>......</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Congrats! All goes well. :-)</span></span></code></pre></div><h4 id="部署tidb集群软件" tabindex="-1">部署TiDB集群软件 <a class="header-anchor" href="#部署tidb集群软件" aria-label="Permalink to &quot;部署TiDB集群软件&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ ansible-playbook deploy.yml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PLAY [check config locally] ***************************************************************************</span></span>
<span class="line"><span></span></span>
<span class="line"><span>......</span></span>
<span class="line"><span>......</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PLAY RECAP ********************************************************************************************</span></span>
<span class="line"><span>192.168.1.41               : ok=53   changed=4    unreachable=0    failed=0   </span></span>
<span class="line"><span>192.168.1.42               : ok=121  changed=16   unreachable=0    failed=0   </span></span>
<span class="line"><span>192.168.1.43               : ok=52   changed=4    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiDB1-11                   : ok=26   changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiDB1-12                   : ok=26   changed=2    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiDB1-21                   : ok=26   changed=2    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiDB1-22                   : ok=26   changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV1-11                   : ok=28   changed=5    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV1-12                   : ok=28   changed=4    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV2-21                   : ok=28   changed=3    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV2-22                   : ok=28   changed=3    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV3-31                   : ok=28   changed=3    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV3-32                   : ok=28   changed=3    unreachable=0    failed=0   </span></span>
<span class="line"><span>localhost                  : ok=7    changed=4    unreachable=0    failed=0   </span></span>
<span class="line"><span></span></span>
<span class="line"><span>Congrats! All goes well. :-)</span></span></code></pre></div><h4 id="安装dashboard依赖包" tabindex="-1">安装Dashboard依赖包 <a class="header-anchor" href="#安装dashboard依赖包" aria-label="Permalink to &quot;安装Dashboard依赖包&quot;">​</a></h4><p>Grafana Dashboard 上的 Report 按钮可用来生成 PDF 文件，此功能依赖 fontconfig 包和英文字体。如</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@tidb01-41 tmp]# sudo yum install fontconfig open-sans-fonts</span></span></code></pre></div><h4 id="执行start启动tidb集群" tabindex="-1">执行start启动TiDB集群 <a class="header-anchor" href="#执行start启动tidb集群" aria-label="Permalink to &quot;执行start启动TiDB集群&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ ansible-playbook start.yml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PLAY [check config locally] **********************************************************************************************</span></span>
<span class="line"><span></span></span>
<span class="line"><span>......</span></span>
<span class="line"><span>......</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PLAY RECAP *******************************************************************************************************************************************************************************************************</span></span>
<span class="line"><span>192.168.1.41               : ok=9    changed=2    unreachable=0    failed=0   </span></span>
<span class="line"><span>192.168.1.42               : ok=34   changed=10   unreachable=0    failed=0   </span></span>
<span class="line"><span>192.168.1.43               : ok=12   changed=3    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiDB1-11                   : ok=6    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiDB1-12                   : ok=6    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiDB2-21                   : ok=6    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiDB2-22                   : ok=6    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV1-11                   : ok=8    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV1-12                   : ok=8    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV2-21                   : ok=8    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV2-22                   : ok=8    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV3-31                   : ok=8    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>TiKV3-32                   : ok=8    changed=1    unreachable=0    failed=0   </span></span>
<span class="line"><span>localhost                  : ok=7    changed=4    unreachable=0    failed=0   </span></span>
<span class="line"><span></span></span>
<span class="line"><span>Congrats! All goes well. :-)</span></span></code></pre></div><h2 id="验证是否安装成功" tabindex="-1">验证是否安装成功 <a class="header-anchor" href="#验证是否安装成功" aria-label="Permalink to &quot;验证是否安装成功&quot;">​</a></h2><ul><li>MySQL客户端连接验证</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ mysql -uroot -P4000 -h192.168.1.43</span></span>
<span class="line"><span>Welcome to the MariaDB monitor.  Commands end with ; or \\g.</span></span>
<span class="line"><span>Your MySQL connection id is 18</span></span>
<span class="line"><span>Server version: 5.7.25-TiDB-v3.0.1 MySQL Community Server (Apache License 2.0)</span></span>
<span class="line"><span>MySQL [(none)]&gt; exit</span></span>
<span class="line"><span>Bye</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ mysql -uroot -P4000 -h192.168.1.42</span></span>
<span class="line"><span>Welcome to the MariaDB monitor.  Commands end with ; or \\g.</span></span>
<span class="line"><span>Your MySQL connection id is 17</span></span>
<span class="line"><span>Server version: 5.7.25-TiDB-v3.0.1 MySQL Community Server (Apache License 2.0)</span></span>
<span class="line"><span>MySQL [(none)]&gt; exit</span></span>
<span class="line"><span>Bye</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ mysql -uroot -P4001 -h192.168.1.43</span></span>
<span class="line"><span>ERROR 2003 (HY000): Can&#39;t connect to MySQL server on &#39;192.168.1.43&#39; (111)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ mysql -uroot -P4001 -h192.168.1.42</span></span>
<span class="line"><span>ERROR 2003 (HY000): Can&#39;t connect to MySQL server on &#39;192.168.1.42&#39; (111)</span></span></code></pre></div><p><strong>出现了TiDB实例没有起来的状况，但是ansible没有报错！</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[tidb@tidb02-42 deploy]$ pwd</span></span>
<span class="line"><span>/data1/deploy</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[tidb@tidb02-42 deploy]$ ./bin/tidb-server -P 4001 --status=10081 1-advertise-address=192.168.1.42 --path=192.168.1.42:2379,192.168.1.43:2379 --config=conf/tidb.toml --log-slow-query=/data1/deploy/log/tidb_slow_query.log --log-file=/data1/deploy/log/tidb.log</span></span>
<span class="line"><span></span></span>
<span class="line"><span>......</span></span>
<span class="line"><span>......</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[2021/01/06 10:08:41.846 -05:00] [INFO] [domain.go:554] [&quot;domain closed&quot;] [&quot;take time&quot;=82.116µs]</span></span>
<span class="line"><span>sync log err: sync /dev/stdout: invalid argument</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[tidb@tidb01-41 tidb-ansible]$ mysql -uroot -P4001 -h192.168.1.42</span></span>
<span class="line"><span>Welcome to the MariaDB monitor.  Commands end with ; or \\g.</span></span>
<span class="line"><span>Your MySQL connection id is 1</span></span>
<span class="line"><span>Server version: 5.7.25-TiDB-v3.0.1 MySQL Community Server (Apache License 2.0)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>MySQL [(none)]&gt; exit</span></span>
<span class="line"><span>Bye</span></span></code></pre></div><ul><li>grafana图形界面验证 <img src="http://cdn.lifemini.cn/dbblog/20210106/9e1e0fde9ec446c7ae32df0a6f1f5338.png" alt="grafana节点校验"></li></ul><h2 id="参考文章" tabindex="-1">参考文章 <a class="header-anchor" href="#参考文章" aria-label="Permalink to &quot;参考文章&quot;">​</a></h2><p><a href="https://docs.pingcap.com/zh/tidb/stable/online-deployment-using-ansible#%E5%8D%95%E6%9C%BA%E5%A4%9A-tikv-%E5%AE%9E%E4%BE%8B%E9%9B%86%E7%BE%A4%E6%8B%93%E6%89%91" target="_blank" rel="noreferrer">PingCAP官方文档-单机单 TiKV 实例集群拓扑</a></p>`,57)]))}const o=a(l,[["render",t]]);export{E as __pageData,o as default};

> [DBNEST -- Bilibili DataGuard 基础搭建视频地址](https://www.bilibili.com/video/BV1Ep4y197JA?from=search&seid=17237800447886927935&spm_id_from=333.337.0.0)    
> [DBNEST -- 旧版文档 “点击” 直接浏览或下载 PDF](./Oracle11gRAC集群搭建手册.pdf) 


## 一、DataGuard 优点
### 1.1 灾难恢复与高可用性
Data Guard提供了高效、全面的灾难恢复和高可用性解决方案。
易于管理的切换和故障转移功能允许在主数据库和备用数据库之间进行角色转换，
从而最小化主数据库在计划内和计划外停机时的停机时间。


### 1.2 完整的数据保护
数据保护可以确保零数据丢失，即使面对不可预见的灾难，备用数据库可以防止数据损坏和用户错误。由于从主库接收的redo重做数据会在备用库验证，所以主库的存储级物理损坏不会传播到备库，可以防止导致主库永久损坏的逻辑损坏或用户错误。



### 1.3 有效利用系统资源
使用从主库接收到的重做数据更新的备库表可用于其他任务，如备份、报告、求和和查询，
从而减少主库执行这些任务所需的主数据库工作负载，节省宝贵的CPU和I/O周期。



### 1.4 灵活平衡可用性和性能
Oracle Data Guard提供了最大的保护、最大的可用性和最大的性能模式，帮助企业平衡数据可用性和系统性能需求。





### 1.5 自动间隙检测
如果主数据库和一个或多个备用数据库之间失连(例如，由于网络问题)，redo数据无法正常传送。
一旦重新连接，DG会自动检测丢失的归档重做日志文件(称为gap)，自动将丢失的归档重做日志文件传输到备库，备用数据库与主数据库是同步的，DBA无需手动干预。



### 1.6 集中简单管理
数据保护代理提供图形用户界面(Data Guard Broker)和命令行界面，以便在数据保护配置中跨多个数据库自动化管理和操作任务。代理还监视单个数据保护配置中的所有系统。



### 1.7 与 Oracle 数据库集成
数据保护是Oracle数据库企业版的一个特性，不需要像RAC一样单独安装。



### 1.8 自动转换角色

当启用快速启动故障转移时，在主站点发生灾难时，数据保护代理自动故障转移到同步备用站点，不需要DBA的干预。此外，还会自动通知应用程序角色转换。




## 二、DG 基本概念

Oracle Data Guard企业数据的高可用性、数据保护和灾难恢复,简称：**DG** 。DG提供一组全面的服务，用于创建、维护、管理和监视一个或多个备用数据库，使**生产库**能够在**灾难和数据损坏时**幸存。

1. DG将备库作为生产库副本的方式进行维护，当生产数据库由于计划或计划外的停机而变得不可用时，DG可以将任何备用数据库切换到主库角色，从而最小化与停机相关的停机时间。
2. DG可以与传统的备份、恢复和集群技术一起使用，以提供高水平的数据保护和数据可用性。
3. DG可以将资源密集型备份和报告操作转移到备用系统优化生产库性能。

![DG原理图](http://cdn.lifemini.cn/dbblog/20210115/a501d3e4459f44dda10f896e7694ede3.png)


DG由一个主库和若干备库组成，主备库之间以网络连接。
主备库之间相互沟通，不受仅能使用本地局域网络限制。
**例如**：你可以在“北京”和“上海”两地的两台同版本Oracle数据库之间搭建一个DG。



### 2.1 物理备用数据库

在磁盘上的数据库结构与主数据库在块对块的基础上相同,提供与主库物理上相同的副本。
数据库模式(包括索引)是相同的。物理备用数据库通过Redo Apply与主数据库保持同步，
Redo Apply恢复从主数据库接收到的重做数据，并将redo应用于物理备库。

**Active Data Guard(ADG)**
从Oracle数据库11g版本1(11.1)开始，物理备库可以在**只读模式打开时**接收和应用重做redo。
因此，可以同时使用物理备用数据库进行数据保护和报告。
![物理备库](http://cdn.lifemini.cn/dbblog/20210115/2a065e73ddcf478c9954bc48af0a172e.png)





### 2.2 逻辑备用数据库

数据的物理组织和结构可能不同，如：平台异构。主库与备库逻辑信息相同。逻辑备库通过SQL Apply与主库同步，后者将从主数据库接收的重做中的数据转换为SQL语句，然后在备用数据库上执行SQL语句。

将主库的redo log传递到备库后，再利用logminer 的工具，从redo log中解析出sql语句，在备库执行，保证和主库同步。（主库和备库可以是不同的环境，备库可以处于读写状态）逻辑备库可以看作是一个单独的库，数据库名和DBID和主库都不一样。（物理的备库和主库的数据库名和DBID都是同样的。）

除了灾难恢复外，用户可以随时访问用于查询和报告目的的逻辑备库。使用逻辑备库，可升级Oracle数据库软件和补丁集，几乎不需要停机。因此，可以同时使用逻辑备用数据库进行数据保护、报告和数据库升级。
![逻辑备库](http://cdn.lifemini.cn/dbblog/20210115/5e0e0837d27b42b68d6e52860583637e.png)





### 2.3 备用数据库快照

#### 快照备用数据库是完全可更新的备用数据库。

与物理或逻辑备库一样，快照备库从主库接收并归档redo数据。
与物理或逻辑备库不同，快照备用数据库不应用它接收到的重做数据。
快照备库接收到的重做数据在将快照备库转换回物理备库之前不会应用，
转换物理备库之前，将首先丢弃对快照备库所做的任何本地更新。


## 三、数据保护模式
某些情况下，企业都承担不起丢失数据的代价；
某些情况下，数据库的可用性可能比任何潜在的数据丢失更重要；
某些情况下，一些应用程序在任何时候都需要最大的数据库性能，如果任何组件出现故障，可以容忍少量的数据丢失。为满足以上不同需求，故而产生不同的保护模式。


### 3.1 最大性能模式
这是默认的保护模式。
它在不影响主数据库性能的情况下提供了最高级别的数据保护。这是通过允许事务在由那些事务生成的所有重做数据被写入在线日志后立即提交来实现的。重做数据也写入一个或多个备用数据库，但这是根据事务承诺异步完成的，因此主数据库性能不受向备用数据库写入重做数据延迟的影响。

### 3.2 最大可用性模式
此模式在不影响主数据库可用性的情况下，提供了最高级别的数据保护。
事务只有在将恢复这些事务所需的所有重做数据写入至少一个同步备用数据库的在线重做日志和备用重做日志之后才会提交。如果主数据库不能将其重做流写入至少一个同步备用数据库，则其操作方式就像处于最大性能模式，以保持主数据库可用性，直到再次能够将其重做流写入同步备用数据库为止。这种保护模式可以确保零数据丢失，除非出现某些双重故障，例如备用数据库失败后主数据库失败。
此模式提供的数据保护略少于最大可用性模式，对主数据库性能的影响也很小。

### 3.3 最大保护模式
此模式确保在主数据库失败时不会发生数据丢失。
为了提供这种级别的保护，在事务提交之前，必须将恢复事务所需的重做数据写入至少一个同步备用数据库上的redo日志和备用redo日志。为了确保不会发生数据丢失，如果主数据库不能将其重做流写入至少一个同步备用数据库，则主数据库将关闭，而不是继续处理事务。



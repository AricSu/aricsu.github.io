{"version":3,"file":"index.js","sources":["../src/plugin.ts"],"sourcesContent":["/**\n * Forked and modified from https://github.com/Antonio-Laguna/markdown-it-image-figures\n */\nimport type { PluginWithOptions } from \"markdown-it\";\nimport type { RuleCore } from \"markdown-it/lib/parser_core.mjs\";\nimport type Token from \"markdown-it/lib/token.mjs\";\n\nimport type { MarkdownItFigureOptions } from \"./options.js\";\n\nconst removeAttribute = (token: Token, attribute: string): void => {\n  token.attrs = token.attrs?.filter(([key]) => key !== attribute) ?? null;\n};\n\nconst getCaption = (image: Token): string => {\n  const title = image.attrs?.find(([attr]) => attr === \"title\")?.[1];\n\n  if (title) {\n    removeAttribute(image, \"title\");\n\n    return title;\n  }\n\n  return image.content;\n};\n\nexport const figure: PluginWithOptions<MarkdownItFigureOptions> = (\n  md,\n  options = {},\n) => {\n  const figureRule: RuleCore = (state) => {\n    // do not process first and last token\n    for (\n      let index = 1, { length } = state.tokens;\n      index < length - 1;\n      index++\n    ) {\n      const token = state.tokens[index];\n\n      if (token.type !== \"inline\") continue;\n\n      // children: image alone, or link_open -> image -> link_close\n      if (\n        !token.children ||\n        (token.children.length !== 1 && token.children.length !== 3)\n      )\n        continue;\n\n      // one child, should be img\n      if (token.children.length === 1 && token.children[0].type !== \"image\")\n        continue;\n\n      // three children, should be image enclosed in link\n      if (token.children.length === 3) {\n        const [childrenA, childrenB, childrenC] = token.children;\n        const isEnclosed =\n          childrenA.type !== \"link_open\" ||\n          childrenB.type !== \"image\" ||\n          childrenC.type !== \"link_close\";\n\n        if (isEnclosed) continue;\n      }\n\n      // prev token is paragraph open\n      if (index !== 0 && state.tokens[index - 1].type !== \"paragraph_open\")\n        continue;\n\n      // next token is paragraph close\n      if (\n        index !== length - 1 &&\n        state.tokens[index + 1].type !== \"paragraph_close\"\n      )\n        continue;\n\n      // We have inline token containing an image only.\n      // Previous token is paragraph open.\n      // Next token is paragraph close.\n      // Lets replace the paragraph tokens with figure tokens.\n      const figure = state.tokens[index - 1];\n\n      figure.type = \"figure_open\";\n      figure.tag = \"figure\";\n      state.tokens[index + 1].type = \"figure_close\";\n      state.tokens[index + 1].tag = \"figure\";\n\n      // for linked images, image is one off\n      const image =\n        token.children.length === 1 ? token.children[0] : token.children[1];\n\n      const figCaption = getCaption(image);\n      const [captionContent] = md.parseInline(figCaption, state.env);\n\n      token.children.push(new state.Token(\"figcaption_open\", \"figcaption\", 1));\n      token.children.push(...(captionContent.children ?? []));\n      token.children.push(\n        new state.Token(\"figcaption_close\", \"figcaption\", -1),\n      );\n\n      if (options.focusable !== false) image.attrPush([\"tabindex\", \"0\"]);\n    }\n  };\n\n  md.core.ruler.before(\"linkify\", \"figure\", figureRule);\n};\n"],"names":["removeAttribute","token","attribute","key","getCaption","image","title","attr","figure","md","options","figureRule","state","index","length","childrenA","childrenB","childrenC","figCaption","captionContent"],"mappings":"AASA,MAAMA,EAAkB,CAACC,EAAcC,IAA4B,CACjED,EAAM,MAAQA,EAAM,OAAO,OAAO,CAAC,CAACE,CAAG,IAAMA,IAAQD,CAAS,GAAK,IACrE,EAEME,EAAcC,GAAyB,CAC3C,MAAMC,EAAQD,EAAM,OAAO,KAAK,CAAC,CAACE,CAAI,IAAMA,IAAS,OAAO,IAAI,CAAC,EAEjE,OAAID,GACFN,EAAgBK,EAAO,OAAO,EAEvBC,GAGFD,EAAM,OACf,EAEaG,EAAqD,CAChEC,EACAC,EAAU,CAAA,IACP,CACH,MAAMC,EAAwBC,GAAU,CAEtC,QACMC,EAAQ,EAAG,CAAE,OAAAC,CAAO,EAAIF,EAAM,OAClCC,EAAQC,EAAS,EACjBD,IACA,CACA,MAAMZ,EAAQW,EAAM,OAAOC,CAAK,EAYhC,GAVIZ,EAAM,OAAS,UAIjB,CAACA,EAAM,UACNA,EAAM,SAAS,SAAW,GAAKA,EAAM,SAAS,SAAW,GAKxDA,EAAM,SAAS,SAAW,GAAKA,EAAM,SAAS,CAAC,EAAE,OAAS,QAC5D,SAGF,GAAIA,EAAM,SAAS,SAAW,EAAG,CAC/B,KAAM,CAACc,EAAWC,EAAWC,CAAS,EAAIhB,EAAM,SAMhD,GAJEc,EAAU,OAAS,aACnBC,EAAU,OAAS,SACnBC,EAAU,OAAS,aAEL,QAClB,CAOA,GAJIJ,IAAU,GAAKD,EAAM,OAAOC,EAAQ,CAAC,EAAE,OAAS,kBAKlDA,IAAUC,EAAS,GACnBF,EAAM,OAAOC,EAAQ,CAAC,EAAE,OAAS,kBAEjC,SAMF,MAAML,EAASI,EAAM,OAAOC,EAAQ,CAAC,EAErCL,EAAO,KAAO,cACdA,EAAO,IAAM,SACbI,EAAM,OAAOC,EAAQ,CAAC,EAAE,KAAO,eAC/BD,EAAM,OAAOC,EAAQ,CAAC,EAAE,IAAM,SAG9B,MAAMR,EACJJ,EAAM,SAAS,SAAW,EAAIA,EAAM,SAAS,CAAC,EAAIA,EAAM,SAAS,CAAC,EAE9DiB,EAAad,EAAWC,CAAK,EAC7B,CAACc,CAAc,EAAIV,EAAG,YAAYS,EAAYN,EAAM,GAAG,EAE7DX,EAAM,SAAS,KAAK,IAAIW,EAAM,MAAM,kBAAmB,aAAc,CAAC,CAAC,EACvEX,EAAM,SAAS,KAAK,GAAIkB,EAAe,UAAY,CAAG,CAAA,EACtDlB,EAAM,SAAS,KACb,IAAIW,EAAM,MAAM,mBAAoB,aAAc,EAAE,CACtD,EAEIF,EAAQ,YAAc,IAAOL,EAAM,SAAS,CAAC,WAAY,GAAG,CAAC,CACnE,CACF,EAEAI,EAAG,KAAK,MAAM,OAAO,UAAW,SAAUE,CAAU,CACtD"}